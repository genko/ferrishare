{% extends "base.html" %}

{% block head %}
{% set page_title = "Admin Panel" %}
{% set page_description = "FerriShare's site-wide administration panel" %}
{% endblock %}

{% block content %}
<noscript>
  <div
    class="flex max-w-lg mx-auto flex-col gap-4 p-4 sm:p-8 mb-8 rounded-xl bg-amber-50 text-amber-700 border-2 border-amber-500 shadow-lg">
    <div class="flex items-center gap-4">
      <span class="matsym bigger" aria-hidden="true">code</span>
      <h3 class="text-lg font-bold">JavaScript Recommended</h3>
    </div>
    <p>
      While most of the information on this page is rendered server-side, the file-deletion buttons only work if JavaScript is enabled.
    </p>
  </div>
</noscript>
<div class="max-w-lg sm:shadow-md bg-zinc-100 sm:rounded-xl flex flex-col gap-8 sm:p-8 mx-auto mb-8">
  <div class="flex flex-col-reverse sm:flex-row sm:justify-between gap-8 items-stretch">
    <h2 class="flex gap-4 text-2xl self-center">
      <span class="matsym big" aria-hidden="true">query_stats</span>
      <span>Admin Statistics</span>
    </h2>
    <form method="post" action="/admin_logout" class="flex justify-center items-center">
      <button type="submit" class="btn-secondary">
        <span>Logout</span>
        <span class="matsym" aria-hidden="true">logout</span>
      </button>
    </form>
  </div>
  <ul class="flex flex-col gap-6">
    <li class="flex items-center gap-4">
      <span class="matsym big text-zinc-500" aria-hidden="true">bar_chart</span>
      <div class="flex flex-col">
        <span class="text-zinc-600">Files Currently Live</span>
        <span class="text-2xl font-bold">{{ full_file_count }}</span>
      </div>
    </li>
    <li class="flex items-center gap-4">
      <span class="matsym big text-zinc-500" aria-hidden="true">data_usage</span>
      <div class="flex flex-col">
        <span class="text-zinc-600">Storage Use</span>
        <span class="flex items-baseline gap-2">
          <span class="text-2xl font-bold">{{ used_quota }}</span>
          <span>/ {{ maximum_quota }}</span>
        </span>
      </div>
    </li>
  </ul>
</div>

<div class="max-w-lg sm:shadow-md bg-zinc-100 sm:rounded-xl flex flex-col gap-8 sm:p-8 mx-auto mb-8">
  <h2 class="flex gap-4 text-2xl items-center justify-center">
    <span class="matsym big" aria-hidden="true">key</span>
    <span>Upload Tokens</span>
  </h2>
  <p class="text-center text-zinc-600">
    One-time tokens required for file uploads. Create tokens to allow users to upload files.
  </p>
  <button type="button" id="create-token-button" class="btn-primary">
    <span class="matsym" aria-hidden="true">add</span>
    <span>Create New Token</span>
  </button>
  <div id="token-display" class="hidden flex-col gap-4 p-4 rounded-lg bg-green-50 border-2 border-green-500">
    <div class="flex items-center gap-4">
      <span class="matsym text-green-700" aria-hidden="true">check_circle</span>
      <h3 class="text-lg font-bold text-green-700">Token Created</h3>
    </div>
    <div class="flex flex-col gap-2">
      <p class="text-sm text-green-700">Copy this token and share it with the user. It will only be shown once:</p>
      <div class="flex gap-2">
        <input type="text" id="token-value" readonly class="flex-1 px-4 py-2 font-mono text-sm border-2 border-green-500 rounded bg-white">
        <button type="button" id="copy-token-button" class="btn-secondary">
          <span class="matsym" aria-hidden="true">content_copy</span>
        </button>
      </div>
    </div>
  </div>
  {% if tokens %}
  <div class="flex flex-col gap-4">
    <h3 class="text-lg font-bold text-center">All Tokens</h3>
    <div class="flex flex-col gap-4">
      {% for token in tokens %}
      <div class="flex flex-col gap-2 p-4 rounded-lg bg-zinc-200 border-2 {% if token.used %}border-zinc-400{% else %}border-green-500{% endif %}">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-2">
            <span class="matsym text-zinc-500" aria-hidden="true">{% if token.used %}check{% else %}key{% endif %}</span>
            <span class="font-mono text-sm break-all">{{ token.token_sha256sum_short }}...</span>
          </div>
          <button type="button" class="delete-token-button btn-secondary" data-token-id="{{ token.id }}">
            <span class="matsym" aria-hidden="true">delete</span>
          </button>
        </div>
        <div class="text-sm text-zinc-600">
          <div>Created: {{ token.created_ts_pretty }} <span class="text-xs">{{ token.created_ts }}</span></div>
          {% if token.used %}
          <div>Used: {{ token.used_ts_pretty }} <span class="text-xs">{{ token.used_ts }}</span></div>
          <div>By IP: {{ token.used_by_ip_pretty }}</div>
          {% else %}
          <div class="text-green-700 font-bold">Not used yet</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <p class="text-center text-zinc-600">No tokens created yet.</p>
  {% endif %}
</div>

<div class="max-w-lg xl:max-w-7xl xl:shadow-lg xl:bg-zinc-100 xl:rounded-xl flex flex-col xl:p-8 gap-8 mx-auto">
  <h2 class="flex gap-4 text-2xl items-center justify-center xl:justify-start sm:mr-4 mt-8 xl:mt-0">
    <span class="matsym big" aria-hidden="true">home_storage</span>
    <span class="text-balance">All Uploaded Files</span>
  </h2>
  {% if files %}
  <table>
    <thead>
      <tr class="hidden xl:table-row text-left *:font-bold *:p-4 text-zinc-600">
        <th> File Hash </th>
        <th> Size </th>
        <th> Upload IP </th>
        <th> Uploaded </th>
        <th> Expires in </th>
        <th>
          <div class="flex justify-center">
            <span class="matsym" aria-label="Downloads">download</span>
          </div>
        </th>
        <th>
          <div class="flex justify-center">
            <span class="matsym" aria-label="Delete Button">delete</span>
          </div>
        </th>
      </tr>
    </thead>
    <tbody class="xl:table-row-group flex flex-col gap-8">
      {% for file in files %}
      <tr
        class="flex xl:table-row flex-col xl:*:p-4 gap-4 sm:gap-6 xl:border-t-2 xl:border-gray-200 rounded-xl bg-zinc-200 sm:bg-zinc-100 xl:bg-inherit shadow-lg xl:shadow-none p-4 sm:p-8 xl:p-0">
        <td class="flex xl:table-cell flex-row items-center gap-4">
          <div class="xl:hidden matsym text-zinc-500" aria-hidden="true">code</div>
          <div class="flex flex-col">
            <div class="xl:hidden text-zinc-600">File Hash</div>
            <div class="text-base xl:text-sm font-mono break-all max-w-[22ch]">{{ file.efd_sha256sum }}</div>
          </div>
        </td>
        <td class="flex xl:table-cell flex-row items-center gap-4">
          <div class="xl:hidden matsym text-zinc-500" aria-hidden="true">clock_loader_90</div>
          <div class="flex flex-col">
            <div class="xl:hidden text-zinc-600">Size</div>
            <div class="text-xl xl:text-lg">{{ file.formatted_filesize }}</div>
          </div>
        </td>
        <td class="flex xl:table-cell flex-row items-center gap-4">
          <div class="xl:hidden matsym text-zinc-500" aria-hidden="true">public</div>
          <div class="flex flex-col">
            <div class="xl:hidden text-zinc-600">Upload IP</div>
            <div class="text-xl xl:text-lg">{{ file.upload_ip_pretty }}</div>
          </div>
        </td>
        <td class="flex xl:table-cell flex-row items-center gap-4">
          <div class="xl:hidden matsym text-zinc-500" aria-hidden="true">note_add</div>
          <div class="flex flex-col">
            <div class="xl:hidden text-zinc-600">Uploaded</div>
            <div class="flex flex-col gap-0 items-baseline text-xl xl:text-lg">
              <div class="text-xl xl:text-lg">
                {{ file.upload_ts_pretty }}
              </div>
              <div class="text-zinc-600 text-sm">
                {{ file.upload_ts }}
              </div>
            </div>
          </div>
        </td>
        <td class="flex xl:table-cell flex-row items-center gap-4">
          <div class="xl:hidden matsym text-zinc-500" aria-hidden="true">auto_delete</div>
          <div class="flex flex-col">
            <div class="xl:hidden text-zinc-600">Expires in</div>
            <div class="flex flex-col gap-0 items-baseline text-xl xl:text-lg">
              <div class="text-xl xl:text-lg">
                {{ file.expiry_ts_pretty }}
              </div>
              <div class="text-zinc-600 text-sm">
                {{ file.expiry_ts }}
              </div>
            </div>
          </div>
        </td>
        <td class="flex xl:table-cell flex-row items-center gap-4">
          <div class="xl:hidden matsym text-zinc-500" aria-hidden="true">download</div>
          <div class="flex flex-col">
            <div class="xl:hidden text-zinc-600">Downloads</div>
            <div class="text-xl xl:text-lg xl:text-center">{{ file.downloads }}</div>
          </div>
        </td>
        <td>
          <button type="button" aria-label="Delete from Server" data-efdhash="{{ file.efd_sha256sum }}"
            class="admin-delete-button no-underline w-full xl:w-auto xl:mx-auto flex items-center justify-center gap-4 p-4 rounded-full bg-zinc-300 font-bold cursor-pointer shadow-none hover:shadow-md active:shadow-none disabled:shadow-none disabled:text-zinc-400 disabled:bg-zinc-300 disabled:cursor-not-allowed">
            <span class="matsym no-underline" aria-hidden="true">delete</span>
            <span class="xl:hidden">Delete from Server</span>
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-center text-xl">No files are currently stored on the server. <a class="classic-link" href="/">Upload
      one!</a></p>
  {% endif %}
</div>

<script>
  // File deletion handler
  async function delete_handler(btn, event) {
    // Disable the button while the request is being processed.
    btn.disabled = true;

    // Create the new request to the deletion-endpoint.
    let xhr = new XMLHttpRequest();
    xhr.open('POST', '/delete_endpoint');
    xhr.setRequestHeader('Content-Type', 'application/json');

    xhr.onload = () => {
      if (xhr.status === 200) {
        // Successful? Strike through all values in the row. (first five <td>s in it)
        for (let i = 0; i < 6; i++) {
          let item = btn.parentElement.parentElement.childNodes[i];
          item.classList.add("line-through");
          item.classList.add("text-zinc-400");
        }
      } else {
        // No fancy interface here, just console.
        console.log(xhr.responseText);
      }
    }

    xhr.send(JSON.stringify({
      hash: btn.dataset.efdhash,
    }))
  }

  for (btn of document.querySelectorAll(".admin-delete-button")) {
    btn.addEventListener("click", delete_handler.bind(null, btn));
  }

  // Token creation handler
  document.getElementById("create-token-button").addEventListener("click", async () => {
    let xhr = new XMLHttpRequest();
    xhr.open('POST', '/create_upload_token');

    xhr.onload = () => {
      if (xhr.status === 200) {
        let response = JSON.parse(xhr.responseText);
        document.getElementById("token-value").value = response.token;
        document.getElementById("token-display").classList.remove("hidden");
        document.getElementById("token-display").classList.add("flex");
        // Reload the page after a delay to show the new token in the list
        setTimeout(() => window.location.reload(), 3000);
      } else {
        console.error("Failed to create token:", xhr.responseText);
        alert("Failed to create token. Please try again.");
      }
    }

    xhr.send();
  });

  // Token copy handler
  document.getElementById("copy-token-button").addEventListener("click", () => {
    let tokenInput = document.getElementById("token-value");
    tokenInput.select();
    document.execCommand("copy");
    
    // Visual feedback
    let btn = document.getElementById("copy-token-button");
    let originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="matsym" aria-hidden="true">check</span>';
    setTimeout(() => {
      btn.innerHTML = originalHTML;
    }, 1000);
  });

  // Token deletion handler
  for (let btn of document.querySelectorAll(".delete-token-button")) {
    btn.addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this token?")) {
        return;
      }

      btn.disabled = true;

      let xhr = new XMLHttpRequest();
      xhr.open('POST', '/delete_upload_token');
      xhr.setRequestHeader('Content-Type', 'application/json');

      xhr.onload = () => {
        if (xhr.status === 200) {
          // Remove the token card from the DOM
          btn.closest(".flex.flex-col.gap-2").remove();
        } else {
          console.error("Failed to delete token:", xhr.responseText);
          alert("Failed to delete token. Please try again.");
          btn.disabled = false;
        }
      }

      xhr.send(JSON.stringify({
        token_id: parseInt(btn.dataset.tokenId)
      }));
    });
  }
</script>
{% endblock %}
